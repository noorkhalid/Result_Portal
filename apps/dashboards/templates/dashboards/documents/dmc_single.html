{% extends "dashboards/_layout.html" %}
{% block title %}DMC (Single Student){% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-0">DMC (Single Student)</h3>
    <div class="text-muted">Department → Program → Session → Semester → Type → Batch → Student</div>
  </div>
</div>

<div class="card p-3">
  <form method="get" class="row g-2">
    <div class="col-md-4">
      <label class="form-label small text-muted mb-1">Department</label>
      <select name="department" class="form-select" onchange="clearAndSubmit(this.form, ['program','session','semester','batch','enrollment']);">
        <option value="">Select Department</option>
        {% for d in departments %}
          <option value="{{ d.id }}" {% if d.id|stringformat:"s" == dept_id %}selected{% endif %}>{{ d.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label small text-muted mb-1">Program</label>
      <select name="program" class="form-select" onchange="clearAndSubmit(this.form, ['session','semester','batch','enrollment']);">
        <option value="">Select Program</option>
        {% for p in programs %}
          <option value="{{ p.id }}" {% if p.id|stringformat:"s" == program_id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label small text-muted mb-1">Session</label>
      <select name="session" class="form-select" onchange="clearAndSubmit(this.form, ['semester','batch','enrollment']);">
        <option value="">Select Session</option>
        {% for s in sessions %}
          <option value="{{ s.id }}" {% if s.id|stringformat:"s" == session_id %}selected{% endif %}>{{ s.start_year }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label small text-muted mb-1">Semester</label>
      <select name="semester" class="form-select" onchange="clearAndSubmit(this.form, ['batch','enrollment']);">
        <option value="">Select Semester</option>
        {% for num in semesters %}
          <option value="{{ num }}" {% if num|stringformat:"s" == semester_no %}selected{% endif %}>{{ num }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label small text-muted mb-1">Result Type</label>
      <select name="result_type" class="form-select" onchange="clearAndSubmit(this.form, ['batch','enrollment']);">
        <option value="regular" {% if ui_type == "regular" %}selected{% endif %}>Regular</option>
        <option value="reappeared" {% if ui_type != "regular" %}selected{% endif %}>Reappeared/Improved</option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label small text-muted mb-1">Result Batch</label>
      <select name="batch" class="form-select" onchange="clearAndSubmit(this.form, ['enrollment']);">
        <option value="">Select Batch</option>
        {% for b in batches %}
          <option value="{{ b.id }}" {% if b.id|stringformat:"s" == batch_id %}selected{% endif %}>
            {{ b.program.name }} | {{ b.session.start_year }} | Sem {{ b.semester_number }} | {{ b.get_result_type_display }}
          </option>
        {% endfor %}
      </select>
      {% if program_id and session_id and semester_no and not batches %}
        <div class="text-muted small mt-1">No result batches found for selected filters.</div>
      {% endif %}
    </div>

    <div class="col-md-6">
      <label class="form-label small text-muted mb-1">Student</label>
      <select name="enrollment" class="form-select" {% if not batch_id %}disabled{% endif %}>
        <option value="">Select Student</option>
        {% for r in students %}
          <option value="{{ r.enrollment_id }}" {% if r.enrollment_id|stringformat:"s" == enrollment_id %}selected{% endif %}>
            {{ r.roll }} | {{ r.reg }} | {{ r.name }}
          </option>
        {% endfor %}
      </select>
      {% if batch_id and not students %}
        <div class="text-muted small mt-1">No semester results found in this batch.</div>
      {% endif %}
    </div>

    <div class="col-md-3 align-self-end">
      <button name="action" value="print" class="btn btn-primary w-100" {% if not batch_id %}disabled{% endif %}>Generate PDF</button>
    </div>
  </form>
</div>

<script>
  function clearAndSubmit(form, names) {
    names.forEach((n) => {
      const el = form.querySelector(`[name="${n}"]`);
      if (el) el.value = '';
    });
    form.submit();
  }
</script>
{% endblock %}
